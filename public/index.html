<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¸­å›½èª å˜èªãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f0f0f0;
      margin-top: 50px;
    }
    /* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ */
    #card-container {
      position: relative;
      width: 300px;
      height: 250px;
      margin: 0 auto;
      border: 1px solid #ccc;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    #card-container.hidden { display: none; }
    /* å˜èªè¡¨ç¤º */
    #card-word {
      font-size: 2em;
    }
    /* å˜èªç•ªå·è¡¨ç¤ºï¼ˆå³ä¸‹ï¼‰ */
    #word-number {
      position: absolute;
      bottom: 5px;
      right: 5px;
      font-size: 0.8em;
      color: #888;
    }
    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼šè©³ç´°æƒ…å ±ï¼†å›ç­”ãƒœã‚¿ãƒ³ */
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px;
    }
    #overlay.hidden { display: none; }
    .pinyin-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5em;
    }
    .example-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1em;
      text-align: left;
      width: 90%;
      line-height: 1.4;
    }
    .buttons-row {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      cursor: pointer;
    }
    #reset-container {
      margin-top: 20px;
    }
    #reset-container.hidden { display: none; }
  </style>
</head>
<body>
  <div id="card-container">
    <div id="card-word"></div>
    <div id="word-number"></div>
    <div id="overlay" class="hidden">
      <div class="pinyin-row">
        <span id="pinyin"></span>
        <button id="replayBtn" title="å˜èªå†ç”Ÿ">ğŸ”ˆï¸</button>
      </div>
      <div id="meaning" style="font-size:1.2em;"></div>
      <div class="example-row">
        <button id="phraseReplayBtn" title="ä¾‹æ–‡å†ç”Ÿ">ğŸ”ˆï¸</button>
        <div id="example"></div>
      </div>
      <div class="buttons-row">
        <button id="superCorrectBtn" title="â—ï¼šæ­£ç­”ã—ã¦ã‚«ãƒ¼ãƒ‰é™¤å¤–">â—</button>
        <button id="correctBtn" title="â—¯ï¼šæ­£ç­”">â—¯</button>
        <button id="incorrectBtn" title="âœ—ï¼šèª¤ç­”">âœ—</button>
      </div>
    </div>
  </div>

  <div id="reset-container" class="hidden">
    <div style="font-size:1.5em; margin-bottom:10px;">ä»Šæ—¥ã®å­¦ç¿’ã¯çµ‚äº†ã—ã¾ã—ãŸ</div>
    <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <script>
    let allWords = [];
    let activeWords = [];
    let currentIndex = 0;
    let resultsData = {};

    // words.json ã¨ /results ã‚’åŒæ™‚ã«èª­ã¿è¾¼ã¿ã€24æ™‚é–“ä»¥å†…ã® SuperCorrect ã‚’é™¤å¤–ã—ã¦ activeWords ã‚’æ±ºå®š
    Promise.all([
      fetch('words.json').then(r => r.json()),
      fetch('/results').then(r => r.json())
    ]).then(([wordsData, resData]) => {
      allWords = wordsData;
      resultsData = resData;
      const now = Date.now();
      activeWords = allWords.filter(word => {
        const rec = resultsData[word.word];
        if (rec && rec.lastSuperCorrect) {
          const last = new Date(rec.lastSuperCorrect).getTime();
          if (now - last < 24 * 3600 * 1000) return false;
        }
        return true;
      });
      chooseNextWord();
      displayWord();
    });

    // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸å‡ºï¼šå„å˜èªã®é‡ã¿ = (100 - accuracy) + 1 (è¨˜éŒ²ãŒãªã‘ã‚Œã° accuracy = 0 ã¨ã™ã‚‹)
    function chooseWeightedIndex() {
      let totalWeight = 0, weights = [];
      activeWords.forEach(word => {
        const rec = resultsData[word.word];
        let accuracy = 0;
        if (rec && rec.history && rec.history.length > 0) {
          const total = rec.history.length;
          const sum = rec.history.reduce((a, b) => a + b, 0);
          accuracy = Math.round((sum / total) * 100);
        }
        const weight = (100 - accuracy) + 1;
        weights.push(weight);
        totalWeight += weight;
      });
      let rnd = Math.random() * totalWeight;
      let cumulative = 0;
      for (let i = 0; i < activeWords.length; i++) {
        cumulative += weights[i];
        if (rnd < cumulative) return i;
      }
      return activeWords.length - 1;
    }

    function chooseNextWord() {
      if (activeWords.length < 1) return;
      currentIndex = chooseWeightedIndex();
    }

    function displayWord() {
      if (activeWords.length < 1) {
        document.getElementById('card-container').classList.add('hidden');
        document.getElementById('reset-container').classList.remove('hidden');
        return;
      }
      const currentWord = activeWords[currentIndex];
      document.getElementById('card-word').textContent = currentWord.word;
      document.getElementById('word-number').textContent = `#${currentWord.number}`;
      document.getElementById('overlay').classList.add('hidden');
    }

    function speakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-TW';
      speechSynthesis.speak(utterance);
    }

    function playAudioWithFallback(url, fallbackFn) {
      const audio = new Audio(url);
      audio.onerror = fallbackFn;
      audio.oncanplaythrough = () => audio.play();
      audio.load();
    }

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ï¼šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã€è©³ç´°ã‚»ãƒƒãƒˆã€å˜èªéŸ³å£°å†ç”Ÿï¼ˆmp3å„ªå…ˆï¼‰
    document.getElementById('card-container').addEventListener('click', function(e) {
      const overlay = document.getElementById('overlay');
      if (overlay.classList.contains('hidden')) {
        const currentWord = activeWords[currentIndex];
        document.getElementById('pinyin').textContent = currentWord.pinyin;
        document.getElementById('meaning').textContent = currentWord.meaning;
        const ex = currentWord.example;
        document.getElementById('example').innerHTML = `<strong>ä¾‹æ–‡:</strong> ${ex.text}<br>
<strong>æ‹¼éŸ³:</strong> ${ex.pinyin}<br>
<strong>è¨³:</strong> ${ex.translation}`;
        overlay.classList.remove('hidden');
        const wordAudioUrl = `mp3/${currentWord.number}_word.mp3`;
        playAudioWithFallback(wordAudioUrl, () => speakText(currentWord.word));
      }
    });

    // å˜èªå†ç”Ÿãƒœã‚¿ãƒ³
    document.getElementById('replayBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      const currentWord = activeWords[currentIndex];
      const wordAudioUrl = `mp3/${currentWord.number}_word.mp3`;
      playAudioWithFallback(wordAudioUrl, () => speakText(currentWord.word));
    });

    // ä¾‹æ–‡å†ç”Ÿãƒœã‚¿ãƒ³
    document.getElementById('phraseReplayBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      const currentWord = activeWords[currentIndex];
      const phraseAudioUrl = `mp3/${currentWord.number}_phrase.mp3`;
      playAudioWithFallback(phraseAudioUrl, () => speakText(currentWord.example.text));
    });

    // ä»®ã®å›ç­”é€ä¿¡å‡¦ç†ï¼ˆå®Ÿéš›ã¯ /results ã¸ã® POST ã§è¨˜éŒ²ï¼‰
    function recordAnswer(result) {
      const currentWord = activeWords[currentIndex];
      fetch('/results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ word: currentWord.word, result: result })
      }).then(response => response.json())
        .then(data => {
          console.log(`Word: ${currentWord.word}, Result: ${result}, Accuracy: ${data.accuracy}`);
          // æ›´æ–°ãŒå¿…è¦ãªã‚‰çµæœãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
        });
    }

    document.getElementById('superCorrectBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      recordAnswer("superCorrect");
      activeWords.splice(currentIndex, 1);
      if (activeWords.length < 1) {
        displayWord();
      } else {
        chooseNextWord();
        displayWord();
      }
    });

    document.getElementById('correctBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      recordAnswer("correct");
      chooseNextWord();
      displayWord();
    });

    document.getElementById('incorrectBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      recordAnswer("incorrect");
      chooseNextWord();
      displayWord();
    });

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼š/resetResults ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚µãƒ¼ãƒãƒ¼å´ã® lastSuperCorrect ã‚’å‰Šé™¤ã—ã€å…¨å˜èªã‚’å†è¡¨ç¤º
    document.getElementById('resetBtn').addEventListener('click', function(e) {
      fetch('/resetResults', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            activeWords = allWords.slice();
            chooseNextWord();
            document.getElementById('reset-container').classList.add('hidden');
            document.getElementById('card-container').classList.remove('hidden');
            displayWord();
          }
        });
    });
  </script>
</body>
</html>
